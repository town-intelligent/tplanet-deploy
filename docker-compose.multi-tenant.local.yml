# Stable environment local override
# Container names: mt-stable-*
# Ports: offset from dev to avoid conflicts
services:
  frontend:
    container_name: mt-stable-frontend
    volumes: !reset []
    command: sh -c "npm run build && npx vite preview --host 0.0.0.0 --port 5170"
    ports: !override
      - "6177:5170"
    environment:
      - VITE_HOST_URL_TPLANET=https://stable.4impact.cc
      - VITE_API_LLMTWINS=https://stable.4impact.cc

  backend:
    container_name: mt-stable-backend
    build:
      context: ./apps/tplanet-daemon
      dockerfile: Dockerfile.multi-tenant
    volumes:
      - /var/www/mt-stable-static/news:/server/backend/static/news
      - /var/www/mt-stable-static/uploads:/server/backend/static/uploads
    command: sh -c "pip install gunicorn && cd /server/backend && python manage.py migrate --noinput && gunicorn backend.wsgi:application --bind 0.0.0.0:5567"
    ports: !override
      - "5581:5567"

  db:
    container_name: mt-stable-db
    ports: !override
      - "5441:5432"

  db-nantou:
    container_name: mt-stable-db-nantou
    ports: !override
      - "5442:5432"
    volumes: !reset
      - db_nantou_data:/var/lib/postgresql/data

  ollama:
    container_name: mt-stable-ollama

  ollama-gateway:
    container_name: mt-stable-ollama-gw
    ports: !override
      - "8183:8082"

  llmtwins:
    container_name: mt-stable-llmtwins
    ports: !override
      - "8013:8002"
    volumes: !reset []

  llmtwins-wrapper:
    container_name: mt-stable-llmtwins-wrapper
    ports: !override
      - "8015:8001"
